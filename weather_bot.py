# === 1. –ò–ú–ü–û–†–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø ===

import os


# –ü—Ä–æ–≤–µ—Ä—è–µ–º: –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Render?
# Render –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è RENDER='true'
# –ï—Å–ª–∏ –µ—ë –Ω–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, –º—ã –ª–æ–∫–∞–ª—å–Ω–æ ‚Üí –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å .env
if os.getenv("RENDER") is None:
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env (–¢–û–õ–¨–ö–û –õ–û–ö–ê–õ–¨–ù–û!)
    from dotenv import load_dotenv

    load_dotenv()  # —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª .env –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ os.environ

# === 2. –ß–¢–ï–ù–ò–ï –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–• –ü–ï–†–ï–ú–ï–ù–ù–´–• ===

# –≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –î–û–õ–ñ–ù–´ –±—ã—Ç—å –∑–∞–¥–∞–Ω—ã:
# - –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –≤ —Ñ–∞–π–ª–µ .env
# - –Ω–∞ Render ‚Äî –≤ Environment Variables (–≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–µ—Ä–≤–∏—Å–∞)
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")  # –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather
OPENWEATHER_API_KEY = os.getenv("OPENWEATHER_API_KEY")  # –ö–ª—é—á —Å openweathermap.org
WEBHOOK_URL = os.getenv("WEBHOOK_URL")  # –ü—É–±–ª–∏—á–Ω—ã–π URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ Render

# –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ —Ö–æ—Ç—å –æ–¥–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –∑–∞–¥–∞–Ω–∞ ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–ø–∞–¥—ë—Ç —Å –ø–æ–Ω—è—Ç–Ω–æ–π –æ—à–∏–±–∫–æ–π
if not TELEGRAM_TOKEN:
    raise RuntimeError("‚ùå TELEGRAM_TOKEN –Ω–µ –∑–∞–¥–∞–Ω!")
if not OPENWEATHER_API_KEY:
    raise RuntimeError("‚ùå OPENWEATHER_API_KEY –Ω–µ –∑–∞–¥–∞–Ω!")
if not WEBHOOK_URL:
    raise RuntimeError(
        "‚ùå WEBHOOK_URL –Ω–µ –∑–∞–¥–∞–Ω! –ü—Ä–∏–º–µ—Ä: https://–≤–∞—à-—Å–µ—Ä–≤–∏—Å.onrender.com"
    )

# === 3. –ò–ú–ü–û–†–¢ –û–°–¢–ê–õ–¨–ù–´–• –ë–ò–ë–õ–ò–û–¢–ï–ö (–ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö) ===

from flask import Flask, abort, request  # Flask ‚Äî –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫
import requests  # –î–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenWeather –∏ Telegram API
import telebot  # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API


# –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞
bot = telebot.TeleBot(TELEGRAM_TOKEN)

# –°–æ–∑–¥–∞—ë–º Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Render —Ç—Ä–µ–±—É–µ—Ç WSGI-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî Flask –µ–≥–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç)
app = Flask(__name__)


# === 4. ENDPOINT –î–õ–Ø –£–°–¢–ê–ù–û–í–ö–ò WEBHOOK (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –í–†–£–ß–ù–£–Æ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä) ===


@app.route("/set_webhook", methods=["GET"])
def set_webhook():
    """
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –≤—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
        https://–≤–∞—à-—Å–µ—Ä–≤–∏—Å.onrender.com/set_webhook

    –û–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å Telegram API, —á—Ç–æ–±—ã —Å–∫–∞–∑–∞—Ç—å:
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—Å—ã–ª–∞–π –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–æ–æ–±—â–µ–Ω–∏—è) –Ω–∞ –º–æ–π URL: {WEBHOOK_URL}/webhook"
    """
    # ‚ö†Ô∏è –í–ê–ñ–ù–û: –ù–ï–¢ –ü–†–û–ë–ï–õ–û–í –º–µ–∂–¥—É 'bot' –∏ —Ç–æ–∫–µ–Ω–æ–º!
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/setWebhook"

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å —Å JSON-—Ç–µ–ª–æ–º: {"url": "https://.../webhook"}
    response = requests.post(url, json={"url": f"{WEBHOOK_URL}/webhook"})

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –±—Ä–∞—É–∑–µ—Ä (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
    return f"Webhook set result: {response.json()}"


# === 5. ENDPOINT –î–õ–Ø –ü–†–ò–Å–ú–ê –°–û–û–ë–©–ï–ù–ò–ô –û–¢ TELEGRAM ===


@app.route("/webhook", methods=["POST"])
def webhook():
    """
    –≠—Ç–æ—Ç endpoint ‚Äî "–ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫" –¥–ª—è Telegram.
    –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É, Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –°–Æ–î–ê.
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—à—ë–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
    if request.headers.get("content-type") == "application/json":
        # –ß–∏—Ç–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
        json_string = request.get_data().decode("utf-8")
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON –≤ –æ–±—ä–µ–∫—Ç Update (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Telegram)
        update = telebot.types.Update.de_json(json_string)
        # –ü–µ—Ä–µ–¥–∞—ë–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ pyTelegramBotAPI –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        bot.process_new_updates([update])
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 200 (—É—Å–ø–µ—Ö)
        return "", 200
    else:
        # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ JSON ‚Äî –æ—Ç–∫–ª–æ–Ω—è–µ–º —Å –æ—à–∏–±–∫–æ–π 403
        abort(403)


# === 6. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î –ò –°–û–û–ë–©–ï–ù–ò–ô ===


@bot.message_handler(commands=["start", "help"])
def send_welcome(message):
    """–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ /start –∏ /help"""
    bot.reply_to(message, "–ü—Ä–∏–≤–µ—Ç! –ù–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ ‚Äî –∏ —è —Å–∫–∞–∂—É –ø–æ–≥–æ–¥—É üå§Ô∏è")


@bot.message_handler(func=lambda message: True)
def get_weather(message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –õ–Æ–ë–û–ï —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∫—Ä–æ–º–µ –∫–æ–º–∞–Ω–¥) –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞"""
    city = message.text.strip()
    if not city:
        bot.reply_to(message, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.")
        return

    try:
        # –ó–∞–ø—Ä–æ—Å –∫ OpenWeatherMap
        url = "http://api.openweathermap.org/data/2.5/weather"
        params = {
            "q": city,  # –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
            "appid": OPENWEATHER_API_KEY,  # –í–∞—à –∫–ª—é—á
            "units": "metric",  # –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ ¬∞C
            "lang": "ru",  # –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≥–æ–¥—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º
        }
        response = requests.get(url, params=params, timeout=10)
        data = response.json()

        if response.status_code == 200:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞
            temp = data["main"]["temp"]
            desc = data["weather"][0]["description"].capitalize()
            feels_like = data["main"]["feels_like"]
            humidity = data["main"]["humidity"]
            wind = data["wind"]["speed"]

            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç–≤–µ—Ç
            answer = (
                f"üå§ –ü–æ–≥–æ–¥–∞ –≤ {city}:\n"
                f"–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels_like}¬∞C)\n"
                f"–û–ø–∏—Å–∞–Ω–∏–µ: {desc}\n"
                f"–í–ª–∞–∂–Ω–æ—Å—Ç—å: {humidity}%\n"
                f"–í–µ—Ç–µ—Ä: {wind} –º/—Å"
            )
            bot.reply_to(message, answer)
        else:
            bot.reply_to(message, "–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ø–∏—Å–∞–Ω–∏–µ.")
    except Exception:
        bot.reply_to(message, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.")


# === 7. –¢–û–ß–ö–ê –í–•–û–î–ê –î–õ–Ø –õ–û–ö–ê–õ–¨–ù–û–ì–û –ó–ê–ü–£–°–ö–ê ===

if __name__ == "__main__":
    """
    –≠—Ç–∞ —á–∞—Å—Ç—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ: python app.py
    –ù–∞ Render –æ–Ω–∞ –ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ Render –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WSGI,
    –Ω–æ Flask –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –Ω—É–∂–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞.
    """
    # Render –ø–µ—Ä–µ–¥–∞—ë—Ç –ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è PORT
    port = int(os.environ.get("PORT", 10000))  # 10000 ‚Äî fallback –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
    app.run(host="0.0.0.0", port=port)  # host="0.0.0.0" ‚Äî —Å–ª—É—à–∞—Ç—å –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
